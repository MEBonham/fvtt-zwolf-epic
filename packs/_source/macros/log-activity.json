{
    "name": "Log Activity",
    "type": "script",
    "img": "icons/svg/book.svg",
    "scope": "global",
    "command": "/**\n * Z-Wolf Epic - Log Activity\n * Logs an activity use for the selected token.\n * Parses granted abilities from the actor's items.\n */\n\n(async () => {\n    // Get selected token\n    if (!canvas.tokens.controlled.length) {\n        ui.notifications.warn(\"Please select a token first.\");\n        return;\n    }\n    \n    const selectedToken = canvas.tokens.controlled[0];\n    const actor = selectedToken.actor;\n    \n    if (!actor) {\n        ui.notifications.error(\"Selected token has no associated actor.\");\n        return;\n    }\n    \n    // Activity types available\n    const activityTypes = {\n        dominant: \"Dominant Action\",\n        swift: \"Swift Action\",\n        reflex: \"Reflex Action\",\n        free: \"Free Action\",\n        passive: \"Passive\"\n    };\n    \n    /**\n     * Parse Universal Activities string to extract individual activities.\n     * @param {string} universalString - The HTML string from Universal Activities\n     * @returns {Array} Array of activity objects\n     */\n    function parseUniversalActivities(universalString) {\n        if (!universalString) return [];\n        \n        // Remove HTML tags to get plain text\n        const tempDiv = document.createElement(\"div\");\n        tempDiv.innerHTML = universalString;\n        const plainText = tempDiv.textContent || \"\";\n        \n        // Split on commas and clean up\n        return plainText\n            .split(\",\")\n            .map(activity => activity.trim())\n            .filter(activity => activity.length > 0);\n    }\n    \n    /**\n     * Get all activities for the actor, organized by type.\n     * @param {Actor} actor - The actor to get activities from\n     * @returns {Object} Activities organized by type\n     */\n    function getActivitiesForActor(actor) {\n        const activities = {\n            dominant: [],\n            swift: [],\n            reflex: [],\n            free: [],\n            passive: []\n        };\n        \n        // Go through all items on the actor\n        for (const item of actor.items) {\n            // Skip virtual items (eidolon base items)\n            if (item.flags?.[\"zwolf-epic\"]?.isVirtual && item.type === \"ancestry\") {\n                continue;\n            }\n            \n            // Process granted abilities\n            const grantedAbilities = item.system.grantedAbilities;\n            if (grantedAbilities) {\n                Object.values(grantedAbilities).forEach(ability => {\n                    const abilityType = ability.activityType?.toLowerCase();\n                    if (abilityType && activities[abilityType]) {\n                        activities[abilityType].push({\n                            name: ability.name,\n                            source: item.name,\n                            description: ability.description || \"\"\n                        });\n                    }\n                });\n            }\n            \n            // For tracks, also check tier abilities\n            if (item.type === \"track\") {\n                const tiers = item.system.tiers;\n                if (tiers) {\n                    for (const [tierKey, tierData] of Object.entries(tiers)) {\n                        const tierAbilities = tierData.grantedAbilities;\n                        if (tierAbilities) {\n                            Object.values(tierAbilities).forEach(ability => {\n                                const abilityType = ability.activityType?.toLowerCase();\n                                if (abilityType && activities[abilityType]) {\n                                    activities[abilityType].push({\n                                        name: ability.name,\n                                        source: `${item.name} (${tierKey.replace(\"tier\", \"Tier \")})`,\n                                        description: ability.description || \"\"\n                                    });\n                                }\n                            });\n                        }\n                    }\n                }\n            }\n        }\n        \n        return activities;\n    }\n    \n    // Get activities for this actor\n    const activities = getActivitiesForActor(actor);\n    \n    // Build dialog content\n    const content = `\n        <form style=\"min-height: 250px;\">\n            <div class=\"form-group\">\n                <label><strong>Activity Type:</strong></label>\n                <select id=\"activity-type\" style=\"width: 100%; margin-top: 5px;\">\n                    <option value=\"\">-- Select Type --</option>\n                    ${Object.entries(activityTypes).map(([key, label]) => \n                        `<option value=\"${key}\">${label}</option>`\n                    ).join(\"\")}\n                </select>\n            </div>\n            <div class=\"form-group\" id=\"activity-name-group\" style=\"display: none; margin-top: 10px;\">\n                <label><strong>Activity:</strong></label>\n                <select id=\"activity-name\" style=\"width: 100%; margin-top: 5px;\">\n                </select>\n            </div>\n            <div id=\"activity-details\" style=\"display: none; margin-top: 10px; padding: 10px; background: #f5f5f5; border-radius: 4px;\">\n                <h4 style=\"margin: 0 0 8px 0;\">Details</h4>\n                <div id=\"activity-source\"></div>\n                <div id=\"activity-description\" style=\"margin-top: 8px;\"></div>\n            </div>\n        </form>\n    `;\n    \n    // Show dialog\n    new foundry.applications.api.DialogV2({\n        window: { title: `Log Activity - ${actor.name}` },\n        content: content,\n        buttons: [\n            {\n                action: \"execute\",\n                icon: \"fas fa-dice\",\n                label: \"Execute\",\n                default: true,\n                callback: async (event, button, dialog) => {\n                    const form = dialog.querySelector(\"form\");\n                    const activityType = form.querySelector(\"#activity-type\").value;\n                    const activitySelect = form.querySelector(\"#activity-name\");\n                    const selectedIndex = parseInt(activitySelect.value);\n                    \n                    if (!activityType || isNaN(selectedIndex)) {\n                        ui.notifications.warn(\"Please select an activity type and activity.\");\n                        return;\n                    }\n                    \n                    const typeActivities = activities[activityType] || [];\n                    const activity = typeActivities[selectedIndex];\n                    \n                    if (!activity) {\n                        ui.notifications.error(\"Selected activity not found.\");\n                        return;\n                    }\n                    \n                    // Create chat message\n                    await ChatMessage.create({\n                        user: game.user.id,\n                        speaker: ChatMessage.getSpeaker({ actor }),\n                        content: `\n                            <h3>Action Logged</h3>\n                            <p><strong>Character:</strong> ${actor.name}</p>\n                            <p><strong>Type:</strong> ${activityTypes[activityType]}</p>\n                            <p><strong>Activity:</strong> ${activity.name}</p>\n                            ${activity.source ? `<p style=\"border-left: 3px solid var(--z-wolf-primary, #2c5aa0); padding-left: 8px;\"><em>Source: ${activity.source}</em></p>` : \"\"}\n                        `,\n                        type: CONST.CHAT_MESSAGE_TYPES.OTHER\n                    });\n                    \n                    console.log(\"Activity logged:\", {\n                        actor: actor.name,\n                        type: activityType,\n                        activity: activity.name,\n                        source: activity.source\n                    });\n                }\n            },\n            {\n                action: \"cancel\",\n                icon: \"fas fa-times\",\n                label: \"Cancel\"\n            }\n        ],\n        render: (event, dialog) => {\n            const form = dialog.querySelector(\"form\");\n            const typeSelect = form.querySelector(\"#activity-type\");\n            const nameGroup = form.querySelector(\"#activity-name-group\");\n            const nameSelect = form.querySelector(\"#activity-name\");\n            const detailsDiv = form.querySelector(\"#activity-details\");\n            const sourceDiv = form.querySelector(\"#activity-source\");\n            const descDiv = form.querySelector(\"#activity-description\");\n            \n            // Update activity list when type changes\n            typeSelect.addEventListener(\"change\", () => {\n                const selectedType = typeSelect.value;\n                const typeActivities = activities[selectedType] || [];\n                \n                // Clear existing options\n                nameSelect.innerHTML = \"\";\n                \n                if (selectedType && typeActivities.length > 0) {\n                    nameGroup.style.display = \"block\";\n                    typeActivities.forEach((activity, index) => {\n                        const option = document.createElement(\"option\");\n                        option.value = index;\n                        option.textContent = activity.name;\n                        nameSelect.appendChild(option);\n                    });\n                    \n                    // Trigger change to show first activity details\n                    nameSelect.dispatchEvent(new Event(\"change\"));\n                } else {\n                    nameGroup.style.display = \"none\";\n                    detailsDiv.style.display = \"none\";\n                    \n                    if (selectedType && typeActivities.length === 0) {\n                        nameSelect.innerHTML = \"<option>No activities of this type</option>\";\n                        nameGroup.style.display = \"block\";\n                    }\n                }\n            });\n            \n            // Update details when activity changes\n            nameSelect.addEventListener(\"change\", () => {\n                const selectedType = typeSelect.value;\n                const selectedIndex = parseInt(nameSelect.value);\n                const typeActivities = activities[selectedType] || [];\n                const activity = typeActivities[selectedIndex];\n                \n                if (activity) {\n                    sourceDiv.innerHTML = activity.source ? `<em>Source: ${activity.source}</em>` : \"\";\n                    descDiv.innerHTML = activity.description || \"<em>No description available.</em>\";\n                    detailsDiv.style.display = \"block\";\n                } else {\n                    detailsDiv.style.display = \"none\";\n                }\n            });\n        },\n        position: {\n            width: 500,\n            height: \"auto\"\n        }\n    }).render(true);\n})();",
    "flags": {},
    "ownership": {
        "default": 0
    }
}
