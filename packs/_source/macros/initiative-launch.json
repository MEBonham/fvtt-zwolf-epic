{
    "name": "Initiative Launch",
    "type": "script",
    "img": "icons/svg/clockwork.svg",
    "scope": "global",
    "command": "/**\n * Z-Wolf Epic - Initiative Launch\n * Opens a dialog to select combatants and set individual boosts for initiative rolls.\n */\n\n// Only allow GM to use this macro\nif (!game.user.isGM) {\n    ui.notifications.warn(\"Only the GM can use this macro.\");\n    return;\n}\n\n// Check for scene and tokens\nif (!canvas.scene) {\n    ui.notifications.warn(\"No active scene!\");\n    return;\n}\n\n// Get all PC and NPC tokens on the scene\nconst validTokens = canvas.tokens.placeables.filter(t => {\n    if (!t.actor) return false;\n    const actorType = t.actor.type;\n    return actorType === \"pc\" || actorType === \"npc\";\n});\n\nif (validTokens.length === 0) {\n    ui.notifications.warn(\"No PC or NPC tokens found on the scene.\");\n    return;\n}\n\n// Check if combat already exists\nif (game.combat && !game.combat.started) {\n    ui.notifications.info(\"Combat already exists. Adding to existing encounter.\");\n}\n\n// Build dialog content\nlet content = `\n<form>\n    <div class=\"form-group\" style=\"margin-bottom: 10px;\">\n        <label style=\"font-weight: bold;\">\n            <input type=\"checkbox\" id=\"select-all\" checked />\n            Select/Deselect All\n        </label>\n    </div>\n    <hr/>\n    <div class=\"token-list\" style=\"max-height: 300px; overflow-y: auto;\">\n`;\n\nvalidTokens.forEach((token, index) => {\n    const name = token.name || \"Unknown\";\n    const tokenClass = token.actor?.type === \"pc\" ? \"pc-token\" : \"npc-token\";\n    content += `\n        <div class=\"token-row ${tokenClass}\" style=\"display: flex; align-items: center; gap: 8px; margin-bottom: 8px; padding: 4px; border-radius: 4px; background: var(--z-wolf-surface, #f5f5f5);\" data-token-id=\"${token.id}\">\n            <input type=\"checkbox\" class=\"token-select\" data-token-id=\"${token.id}\" checked />\n            <span style=\"flex: 1; font-weight: ${token.actor?.type === \"pc\" ? \"bold\" : \"normal\"};\">${name}</span>\n            <div style=\"display: flex; align-items: center; gap: 4px;\">\n                <button type=\"button\" class=\"boost-decr\" data-token-id=\"${token.id}\" style=\"width: 24px; height: 24px; padding: 0;\">-</button>\n                <input type=\"number\" class=\"boost-input\" data-token-id=\"${token.id}\" value=\"0\" style=\"width: 50px; text-align: center;\" />\n                <button type=\"button\" class=\"boost-incr\" data-token-id=\"${token.id}\" style=\"width: 24px; height: 24px; padding: 0;\">+</button>\n            </div>\n        </div>\n    `;\n});\n\ncontent += `\n    </div>\n</form>\n`;\n\n// Create and show dialog\nnew foundry.applications.api.DialogV2({\n    window: { title: \"Initiative Launch\" },\n    content: content,\n    buttons: [\n        {\n            action: \"launch\",\n            icon: \"fas fa-rocket\",\n            label: \"Launch\",\n            default: true,\n            callback: async (event, button, dialog) => {\n                const form = dialog.querySelector(\"form\");\n                const selectedTokens = [];\n                \n                form.querySelectorAll(\".token-select:checked\").forEach(checkbox => {\n                    const tokenId = checkbox.dataset.tokenId;\n                    const boostInput = form.querySelector(`.boost-input[data-token-id=\"${tokenId}\"]`);\n                    const netBoosts = parseInt(boostInput?.value) || 0;\n                    selectedTokens.push({ tokenId, netBoosts });\n                });\n                \n                if (selectedTokens.length === 0) {\n                    ui.notifications.warn(\"No tokens selected!\");\n                    return;\n                }\n                \n                // Create or get combat\n                let combat = game.combat;\n                if (!combat) {\n                    combat = await Combat.create({ scene: canvas.scene.id });\n                }\n                \n                // Add combatants and roll initiative\n                for (const { tokenId, netBoosts } of selectedTokens) {\n                    const token = canvas.tokens.get(tokenId);\n                    if (!token) continue;\n                    \n                    // Check if already in combat\n                    let combatant = combat.combatants.find(c => c.tokenId === tokenId);\n                    \n                    if (!combatant) {\n                        const [newCombatant] = await combat.createEmbeddedDocuments(\"Combatant\", [{\n                            tokenId: tokenId,\n                            actorId: token.actor?.id,\n                            hidden: token.document.hidden\n                        }]);\n                        combatant = newCombatant;\n                    }\n                    \n                    if (combatant) {\n                        // Roll initiative using the actor's agility\n                        const actor = token.actor;\n                        if (actor && window.ZWolfDice) {\n                            const agility = actor.system.attributes?.agility;\n                            const level = actor.system.level || 0;\n                            let modifier = 0;\n                            \n                            if (agility?.progression) {\n                                const bonuses = {\n                                    mediocre: Math.floor(0.6 * level - 0.3),\n                                    moderate: Math.floor(0.8 * level),\n                                    specialty: Math.floor(1 * level),\n                                    awesome: Math.floor(1.2 * level + 0.8001)\n                                };\n                                modifier = bonuses[agility.progression] || 0;\n                            }\n                            \n                            // Perform initiative roll\n                            const rollResult = await ZWolfDice.roll({\n                                netBoosts,\n                                modifier,\n                                flavor: `${token.name} Initiative`,\n                                actor\n                            });\n                            \n                            // Use tiebreaker for initiative value\n                            const tiebreaker = rollResult.finalResult + (modifier * 0.001);\n                            await combatant.update({ initiative: tiebreaker });\n                        } else {\n                            // Fallback: standard roll\n                            await combat.rollInitiative(combatant.id);\n                        }\n                    }\n                }\n                \n                ui.notifications.info(`Rolled initiative for ${selectedTokens.length} combatant(s).`);\n            }\n        },\n        {\n            action: \"cancel\",\n            icon: \"fas fa-times\",\n            label: \"Cancel\"\n        }\n    ],\n    render: (event, dialog) => {\n        const form = dialog.querySelector(\"form\");\n        \n        // Select All handler\n        form.querySelector(\"#select-all\")?.addEventListener(\"change\", (e) => {\n            const checked = e.target.checked;\n            form.querySelectorAll(\".token-select\").forEach(cb => cb.checked = checked);\n        });\n        \n        // Boost increment/decrement handlers\n        form.querySelectorAll(\".boost-incr\").forEach(btn => {\n            btn.addEventListener(\"click\", (e) => {\n                e.preventDefault();\n                const tokenId = btn.dataset.tokenId;\n                const input = form.querySelector(`.boost-input[data-token-id=\"${tokenId}\"]`);\n                input.value = parseInt(input.value) + 1;\n            });\n        });\n        \n        form.querySelectorAll(\".boost-decr\").forEach(btn => {\n            btn.addEventListener(\"click\", (e) => {\n                e.preventDefault();\n                const tokenId = btn.dataset.tokenId;\n                const input = form.querySelector(`.boost-input[data-token-id=\"${tokenId}\"]`);\n                input.value = parseInt(input.value) - 1;\n            });\n        });\n    }\n}).render(true);",
    "flags": {},
    "ownership": {
        "default": 0
    }
}
