{
    "name": "Apply Damage",
    "type": "script",
    "img": "icons/skills/wounds/bone-broken-marrow-yellow.webp",
    "scope": "global",
    "command": "/**\n * Z-Wolf Epic - Apply Damage\n * Applies damage to a selected token with damage type tracking.\n */\n\n// Get selected tokens\nconst tokens = canvas.tokens.controlled;\n\n// Validate selection\nif (tokens.length === 0) {\n    ui.notifications.warn(\"Please select a token first.\");\n    return;\n}\n\nif (tokens.length > 1) {\n    ui.notifications.warn(\"Please select only one token.\");\n    return;\n}\n\nconst token = tokens[0];\nconst actor = token.actor;\n\n// Validate actor exists\nif (!actor) {\n    ui.notifications.error(\"Selected token has no associated actor.\");\n    return;\n}\n\n// Check if user has permission to modify the actor\nif (!actor.isOwner) {\n    ui.notifications.warn(\"You don't have permission to modify this actor.\");\n    return;\n}\n\n// Damage type configuration\nconst damageTypes = {\n    bludgeoning: \"Bludgeoning\",\n    piercing: \"Piercing\",\n    slashing: \"Slashing\",\n    fire: \"Fire\",\n    cold: \"Cold\",\n    lightning: \"Lightning\",\n    corrosive: \"Corrosive\",\n    force: \"Force\",\n    psychic: \"Psychic\",\n    radiant: \"Radiant\",\n    necrotic: \"Necrotic\"\n};\n\n// Build damage type options\nconst damageTypeOptions = Object.entries(damageTypes)\n    .map(([key, label]) => `<option value=\"${key}\">${label}</option>`)\n    .join(\"\");\n\n// Dialog content\nconst content = `\n<form>\n    <div class=\"form-group\">\n        <label>Damage Amount:</label>\n        <input type=\"number\" id=\"damage-amount\" value=\"1\" min=\"0\" step=\"1\" autofocus />\n    </div>\n    <div class=\"form-group\">\n        <label>Damage Type:</label>\n        <select id=\"damage-type\">\n            ${damageTypeOptions}\n        </select>\n    </div>\n</form>\n`;\n\n// Show dialog\nnew foundry.applications.api.DialogV2({\n    window: { title: `Apply Damage - ${token.name}` },\n    content: content,\n    buttons: [\n        {\n            action: \"apply\",\n            icon: \"fas fa-heart-broken\",\n            label: \"Apply\",\n            default: true,\n            callback: async (event, button, dialog) => {\n                const form = dialog.querySelector(\"form\");\n                const amount = parseInt(form.querySelector(\"#damage-amount\").value);\n                const damageType = form.querySelector(\"#damage-type\").value;\n                const damageLabel = damageTypes[damageType];\n                \n                if (amount < 1) {\n                    ui.notifications.warn(\"Damage amount must be greater than zero.\");\n                    return;\n                }\n                \n                // Get current vitality points\n                const vp = actor.system.vitalityPoints;\n                if (!vp) {\n                    ui.notifications.error(\"Actor does not have vitality points.\");\n                    return;\n                }\n                \n                const currentVP = vp.value;\n                const newVP = Math.max(0, currentVP - amount);\n                \n                // Update actor\n                await actor.update({\n                    \"system.vitalityPoints.value\": newVP\n                });\n                \n                // Determine chat message styling\n                const isZero = newVP === 0;\n                const damageStyle = isZero ? \"color: #dc3545; font-weight: bold;\" : \"\";\n                \n                // Create chat message\n                await ChatMessage.create({\n                    user: game.user.id,\n                    speaker: ChatMessage.getSpeaker({ actor }),\n                    content: `\n                        <div style=\"text-align: center; padding: 8px;\">\n                            <h3 style=\"margin: 0 0 4px 0; ${damageStyle}\">${token.name} takes ${amount} ${damageLabel} damage!</h3>\n                            <p style=\"margin: 0 0 4px 0;\">Vitality: ${currentVP} → ${newVP}</p>\n                            ${isZero ? \"<p style=\\\"margin: 0; color: #dc3545; font-weight: bold;\\\">⚠ Vitality Depleted!</p>\" : \"\"}\n                        </div>\n                    `,\n                    type: CONST.CHAT_MESSAGE_TYPES.OTHER\n                });\n                \n                ui.notifications.info(`Applied ${amount} ${damageLabel} damage to ${token.name}.`);\n            }\n        },\n        {\n            action: \"cancel\",\n            icon: \"fas fa-times\",\n            label: \"Cancel\"\n        }\n    ],\n    render: (event, dialog) => {\n        // Auto-focus the damage input\n        setTimeout(() => {\n            dialog.querySelector(\"#damage-amount\")?.focus();\n        }, 50);\n        \n        // Handle Enter key to submit\n        dialog.querySelector(\"form\")?.addEventListener(\"keypress\", (e) => {\n            if (e.which === 13) {\n                e.preventDefault();\n                dialog.querySelector(\"[data-action='apply']\")?.click();\n            }\n        });\n    }\n}).render(true);",
    "flags": {},
    "ownership": {
        "default": 0
    }
}
