<!-- Configure Tab -->
<div class="tab configure" data-group="primary" data-tab="configure">

  <h3>Character Build Configuration</h3>

  <div class="build-sections">

    <!-- Core Character Foundation Section -->
    <div class="build-category character-foundation">
      <h4>Character Foundation</h4>
      <div class="foundation-row">
        
        <div class="foundation-item ancestry-slot">
          <label class="foundation-label">Ancestry</label>
          <div class="foundation-drop-zone drop-zone" data-item-type="ancestry" data-slot="ancestry" title="Drag an Ancestry item here">
            {{#if ancestry}}
              <div class="slotted-item" data-item-id="{{ancestry._id}}">
                <img class="item-image" src="{{ancestry.img}}" alt="{{ancestry.name}}" />
                <div class="item-info">
                  <div class="item-name">{{ancestry.name}}</div>
                </div>
                <div class="item-controls">
                  <a class="item-control item-edit" title="Edit {{ancestry.name}}">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a class="item-control item-remove" title="Remove {{ancestry.name}}">
                    <i class="fas fa-times"></i>
                  </a>
                </div>
              </div>
            {{else}}
              <div class="drop-prompt">
                <i class="fas fa-user-circle"></i>
                <span>Drag Ancestry Here</span>
              </div>
            {{/if}}
          </div>
        </div>

        <div class="foundation-item fundament-slot">
          <label class="foundation-label">Fundament</label>
          <div class="foundation-drop-zone drop-zone" data-item-type="fundament" data-slot="fundament" title="Drag a Fundament item here">
            {{#if fundament}}
              <div class="slotted-item" data-item-id="{{fundament._id}}">
                <img class="item-image" src="{{fundament.img}}" alt="{{fundament.name}}" />
                <div class="item-info">
                  <div class="item-name">{{fundament.name}}</div>
                </div>
                <div class="item-controls">
                  <a class="item-control item-edit" title="Edit {{fundament.name}}">
                    <i class="fas fa-edit"></i>
                  </a>
                  <a class="item-control item-remove" title="Remove {{fundament.name}}">
                    <i class="fas fa-times"></i>
                  </a>
                </div>
              </div>
            {{else}}
              <div class="drop-prompt">
                <i class="fas fa-user-circle"></i>
                <span>Drag Fundament Here</span>
              </div>
            {{/if}}
          </div>
        </div>

      </div>
    </div>

    <!-- Progression Assignments Section -->
    <div class="build-category progression-assignments">
      <!-- Updated Build Points Header with Lock Button -->
      <div class="build-points-header">
        <div class="build-points-display">
          <div class="bp-label">Build Points</div>
          <div class="bp-total {{#if (lt buildPoints.total 0)}}negative{{else}}{{#if (gt buildPoints.total buildPoints.max)}}over-max{{else}}{{#if (eq buildPoints.total buildPoints.max)}}at-max{{/if}}{{/if}}{{/if}}">
            {{buildPoints.total}} / {{buildPoints.max}} BP
          </div>
          <div class="bp-breakdown">
            <span class="bp-breakdown-item">Attributes: {{buildPoints.attributes}} BP</span>
            <span class="bp-breakdown-divider">â€¢</span>
            <span class="bp-breakdown-item">Skills: {{buildPoints.skills}} BP</span>
          </div>
        </div>
        
        <!-- NEW: Lock Button -->
        <div class="build-points-controls">
          <button type="button" class="build-points-lock-btn {{#if system.buildPointsLocked}}locked{{else}}unlocked{{/if}}" 
                  title="{{#if system.buildPointsLocked}}Unlock progression sliders{{else}}Lock progression sliders{{/if}}">
            <i class="fas {{#if system.buildPointsLocked}}fa-lock{{else}}fa-unlock{{/if}}"></i>
            <span class="lock-label">{{#if system.buildPointsLocked}}Locked{{else}}Unlocked{{/if}}</span>
          </button>
        </div>
      </div>

      <div class="progression-config">
        
        <!-- Attributes Section -->
        <div class="config-section">
          <h5><i class="fas fa-user-shield"></i> Attributes</h5>
          <div class="config-list">
            
            <div class="config-row">
              <label class="stat-label">
                {{#if (eq system.attributes.agility.progression 'awesome')}}
                  <i class="fas fa-exclamation-triangle awesome-warning" 
                      title="Awesome Progression for Attributes is only available if granted by a Track or Talent"></i>
                {{/if}}
                Agility
              </label>
              <div class="progression-slider-container">
                <input type="range" 
                      class="progression-slider" 
                      min="1" max="4" 
                      value="{{#if (eq system.attributes.agility.progression 'mediocre')}}1{{else}}{{#if (eq system.attributes.agility.progression 'moderate')}}2{{else}}{{#if (eq system.attributes.agility.progression 'specialty')}}3{{else}}{{#if (eq system.attributes.agility.progression 'awesome')}}4{{else}}2{{/if}}{{/if}}{{/if}}{{/if}}"
                      data-stat="agility" 
                      data-type="attribute" />
                <div class="slider-labels">
                  <span class="slider-label">Med</span>
                  <span class="slider-label">Mod</span>
                  <span class="slider-label">Spec</span>
                  <span class="slider-label">Awe</span>
                </div>
              </div>
            </div>

            <div class="config-row config-row-alt">
              <label class="stat-label">
                {{#if (eq system.attributes.fortitude.progression 'awesome')}}
                  <i class="fas fa-exclamation-triangle awesome-warning" 
                      title="Awesome Progression for Attributes is only available if granted by a Track or Talent"></i>
                {{/if}}
                Fortitude
              </label>
              <div class="progression-slider-container">
                <input type="range" 
                      class="progression-slider" 
                      min="1" max="4" 
                      value="{{#if (eq system.attributes.fortitude.progression 'mediocre')}}1{{else}}{{#if (eq system.attributes.fortitude.progression 'moderate')}}2{{else}}{{#if (eq system.attributes.fortitude.progression 'specialty')}}3{{else}}{{#if (eq system.attributes.fortitude.progression 'awesome')}}4{{else}}2{{/if}}{{/if}}{{/if}}{{/if}}"
                      data-stat="fortitude" 
                      data-type="attribute" />
                <div class="slider-labels">
                  <span class="slider-label">Med</span>
                  <span class="slider-label">Mod</span>
                  <span class="slider-label">Spec</span>
                  <span class="slider-label">Awe</span>
                </div>
              </div>
            </div>

            <div class="config-row">
              <label class="stat-label">
                {{#if (eq system.attributes.perception.progression 'awesome')}}
                  <i class="fas fa-exclamation-triangle awesome-warning" 
                      title="Awesome Progression for Attributes is only available if granted by a Track or Talent"></i>
                {{/if}}
                Perception
              </label>
              <div class="progression-slider-container">
                <input type="range" 
                      class="progression-slider" 
                      min="1" max="4" 
                      value="{{#if (eq system.attributes.perception.progression 'mediocre')}}1{{else}}{{#if (eq system.attributes.perception.progression 'moderate')}}2{{else}}{{#if (eq system.attributes.perception.progression 'specialty')}}3{{else}}{{#if (eq system.attributes.perception.progression 'awesome')}}4{{else}}2{{/if}}{{/if}}{{/if}}{{/if}}"
                      data-stat="perception" 
                      data-type="attribute" />
                <div class="slider-labels">
                  <span class="slider-label">Med</span>
                  <span class="slider-label">Mod</span>
                  <span class="slider-label">Spec</span>
                  <span class="slider-label">Awe</span>
                </div>
              </div>
            </div>

            <div class="config-row config-row-alt">
              <label class="stat-label">
                {{#if (eq system.attributes.willpower.progression 'awesome')}}
                  <i class="fas fa-exclamation-triangle awesome-warning" 
                      title="Awesome Progression for Attributes is only available if granted by a Track or Talent"></i>
                {{/if}}
                Willpower
              </label>
              <div class="progression-slider-container">
                <input type="range" 
                      class="progression-slider" 
                      min="1" max="4" 
                      value="{{#if (eq system.attributes.willpower.progression 'mediocre')}}1{{else}}{{#if (eq system.attributes.willpower.progression 'moderate')}}2{{else}}{{#if (eq system.attributes.willpower.progression 'specialty')}}3{{else}}{{#if (eq system.attributes.willpower.progression 'awesome')}}4{{else}}2{{/if}}{{/if}}{{/if}}{{/if}}"
                      data-stat="willpower" 
                      data-type="attribute" />
                <div class="slider-labels">
                  <span class="slider-label">Med</span>
                  <span class="slider-label">Mod</span>
                  <span class="slider-label">Spec</span>
                  <span class="slider-label">Awe</span>
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Skills Section -->
        <div class="config-section">
          <h5><i class="fas fa-cogs"></i> Skills</h5>
          <div class="config-list">

            <div class="config-item">
              <label class="stat-label">Acumen</label>
              <div class="progression-slider-container">
                <input type="range" 
                      class="progression-slider" 
                      min="1" max="4" 
                      value="{{#if (eq system.skills.acumen.progression 'mediocre')}}1{{else}}{{#if (eq system.skills.acumen.progression 'moderate')}}2{{else}}{{#if (eq system.skills.acumen.progression 'specialty')}}3{{else}}{{#if (eq system.skills.acumen.progression 'awesome')}}4{{else}}1{{/if}}{{/if}}{{/if}}{{/if}}"
                      data-stat="acumen" 
                      data-type="skill" />
                <div class="slider-labels">
                  <span class="slider-label">Med</span>
                  <span class="slider-label">Mod</span>
                  <span class="slider-label">Spec</span>
                  <span class="slider-label">Awe</span>
                </div>
              </div>
            </div>

            <div class="config-item">
              <label class="stat-label">Athletics</label>
              <div class="progression-slider-container">
                <input type="range" 
                      class="progression-slider" 
                      min="1" max="4" 
                      value="{{#if (eq system.skills.athletics.progression 'mediocre')}}1{{else}}{{#if (eq system.skills.athletics.progression 'moderate')}}2{{else}}{{#if (eq system.skills.athletics.progression 'specialty')}}3{{else}}{{#if (eq system.skills.athletics.progression 'awesome')}}4{{else}}1{{/if}}{{/if}}{{/if}}{{/if}}"
                      data-stat="athletics" 
                      data-type="skill" />
                <div class="slider-labels">
                  <span class="slider-label">Med</span>
                  <span class="slider-label">Mod</span>
                  <span class="slider-label">Spec</span>
                  <span class="slider-label">Awe</span>
                </div>
              </div>
            </div>

            <div class="config-item">
              <label class="stat-label">Brawn</label>
              <div class="progression-slider-container">
                <input type="range" 
                      class="progression-slider" 
                      min="1" max="4" 
                      value="{{#if (eq system.skills.brawn.progression 'mediocre')}}1{{else}}{{#if (eq system.skills.brawn.progression 'moderate')}}2{{else}}{{#if (eq system.skills.brawn.progression 'specialty')}}3{{else}}{{#if (eq system.skills.brawn.progression 'awesome')}}4{{else}}1{{/if}}{{/if}}{{/if}}{{/if}}"
                      data-stat="brawn" 
                      data-type="skill" />
                <div class="slider-labels">
                  <span class="slider-label">Med</span>
                  <span class="slider-label">Mod</span>
                  <span class="slider-label">Spec</span>
                  <span class="slider-label">Awe</span>
                </div>
              </div>
            </div>

            <div class="config-item">
              <label class="stat-label">Dexterity</label>
              <div class="progression-slider-container">
                <input type="range" 
                      class="progression-slider" 
                      min="1" max="4" 
                      value="{{#if (eq system.skills.dexterity.progression 'mediocre')}}1{{else}}{{#if (eq system.skills.dexterity.progression 'moderate')}}2{{else}}{{#if (eq system.skills.dexterity.progression 'specialty')}}3{{else}}{{#if (eq system.skills.dexterity.progression 'awesome')}}4{{else}}1{{/if}}{{/if}}{{/if}}{{/if}}"
                      data-stat="dexterity" 
                      data-type="skill" />
                <div class="slider-labels">
                  <span class="slider-label">Med</span>
                  <span class="slider-label">Mod</span>
                  <span class="slider-label">Spec</span>
                  <span class="slider-label">Awe</span>
                </div>
              </div>
            </div>

            <div class="config-item">
              <label class="stat-label">Glibness</label>
              <div class="progression-slider-container">
                <input type="range" 
                      class="progression-slider" 
                      min="1" max="4" 
                      value="{{#if (eq system.skills.glibness.progression 'mediocre')}}1{{else}}{{#if (eq system.skills.glibness.progression 'moderate')}}2{{else}}{{#if (eq system.skills.glibness.progression 'specialty')}}3{{else}}{{#if (eq system.skills.glibness.progression 'awesome')}}4{{else}}1{{/if}}{{/if}}{{/if}}{{/if}}"
                      data-stat="glibness" 
                      data-type="skill" />
                <div class="slider-labels">
                  <span class="slider-label">Med</span>
                  <span class="slider-label">Mod</span>
                  <span class="slider-label">Spec</span>
                  <span class="slider-label">Awe</span>
                </div>
              </div>
            </div>

            <div class="config-item">
              <label class="stat-label">Influence</label>
              <div class="progression-slider-container">
                <input type="range" 
                      class="progression-slider" 
                      min="1" max="4" 
                      value="{{#if (eq system.skills.influence.progression 'mediocre')}}1{{else}}{{#if (eq system.skills.influence.progression 'moderate')}}2{{else}}{{#if (eq system.skills.influence.progression 'specialty')}}3{{else}}{{#if (eq system.skills.influence.progression 'awesome')}}4{{else}}1{{/if}}{{/if}}{{/if}}{{/if}}"
                      data-stat="influence" 
                      data-type="skill" />
                <div class="slider-labels">
                  <span class="slider-label">Med</span>
                  <span class="slider-label">Mod</span>
                  <span class="slider-label">Spec</span>
                  <span class="slider-label">Awe</span>
                </div>
              </div>
            </div>

            <div class="config-item">
              <label class="stat-label">Insight</label>
              <div class="progression-slider-container">
                <input type="range" 
                      class="progression-slider" 
                      min="1" max="4" 
                      value="{{#if (eq system.skills.insight.progression 'mediocre')}}1{{else}}{{#if (eq system.skills.insight.progression 'moderate')}}2{{else}}{{#if (eq system.skills.insight.progression 'specialty')}}3{{else}}{{#if (eq system.skills.insight.progression 'awesome')}}4{{else}}1{{/if}}{{/if}}{{/if}}{{/if}}"
                      data-stat="insight" 
                      data-type="skill" />
                <div class="slider-labels">
                  <span class="slider-label">Med</span>
                  <span class="slider-label">Mod</span>
                  <span class="slider-label">Spec</span>
                  <span class="slider-label">Awe</span>
                </div>
              </div>
            </div>

            <div class="config-item">
              <label class="stat-label">Stealth</label>
              <div class="progression-slider-container">
                <input type="range" 
                      class="progression-slider" 
                      min="1" max="4" 
                      value="{{#if (eq system.skills.stealth.progression 'mediocre')}}1{{else}}{{#if (eq system.skills.stealth.progression 'moderate')}}2{{else}}{{#if (eq system.skills.stealth.progression 'specialty')}}3{{else}}{{#if (eq system.skills.stealth.progression 'awesome')}}4{{else}}1{{/if}}{{/if}}{{/if}}{{/if}}"
                      data-stat="stealth" 
                      data-type="skill" />
                <div class="slider-labels">
                  <span class="slider-label">Med</span>
                  <span class="slider-label">Mod</span>
                  <span class="slider-label">Spec</span>
                  <span class="slider-label">Awe</span>
                </div>
              </div>
            </div>

          </div>
        </div>

      </div>
    </div>

    <!-- Knacks Section -->
    <div class="build-category knacks-section">
      <h4><i class="fas fa-star"></i> Knacks</h4>
      <div class="knacks-grid compact-grid">
        {{#each knackSlots as |slot index|}}
          <div class="knack-slot compact-slot">
            <label class="slot-label">Knack {{math index "+" 1}}</label>
            <div class="knack-drop-zone drop-zone compact-drop-zone" data-item-type="knack" data-slot="knack-{{index}}" title="Drag a Knack item here">
              {{#if slot.item}}
                <div class="slotted-item compact-slotted-item" data-item-id="{{slot.item._id}}">
                  <img class="item-image compact-item-image" src="{{slot.item.img}}" alt="{{slot.item.name}}" />
                  <div class="item-info compact-item-info">
                    <div class="item-name">{{slot.item.name}}</div>
                  </div>
                  <div class="item-controls compact-item-controls">
                    <a class="item-control item-edit" title="Edit {{slot.item.name}}">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-remove" title="Remove {{slot.item.name}}">
                      <i class="fas fa-times"></i>
                    </a>
                  </div>
                </div>
              {{else}}
                <div class="drop-prompt compact-drop-prompt">
                  <i class="fas fa-star"></i>
                  <span>Drag Knack Here</span>
                </div>
              {{/if}}
            </div>
          </div>
        {{/each}}
        
        {{#unless knackSlots.length}}
          <div class="no-slots-message">
            <i class="fas fa-info-circle"></i>
            <span>No knack slots available. Add an Ancestry, Fundament, or Talents to gain knack slots.</span>
          </div>
        {{/unless}}
      </div>
    </div>

    <!-- Tracks Section -->
    <div class="build-category tracks-section">
      <h4><i class="fas fa-road"></i> Tracks</h4>
      <div class="tracks-grid compact-grid">
        {{#each trackSlots as |slot index|}}
          <div class="track-slot compact-slot">
            <label class="slot-label">Track {{math index "+" 1}}</label>
            <div class="track-drop-zone drop-zone compact-drop-zone" data-item-type="track" data-slot="track-{{index}}" title="Drag a Track item here">
              {{#if slot.item}}
                <div class="slotted-item compact-slotted-item" data-item-id="{{slot.item._id}}">
                  <img class="item-image compact-item-image" src="{{slot.item.img}}" alt="{{slot.item.name}}" />
                  <div class="item-info compact-item-info">
                    <div class="item-name">{{slot.item.name}}</div>
                  </div>
                  <div class="item-controls compact-item-controls">
                    <a class="item-control item-edit" title="Edit {{slot.item.name}}">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-remove" title="Remove {{slot.item.name}}">
                      <i class="fas fa-times"></i>
                    </a>
                  </div>
                </div>
              {{else}}
                <div class="drop-prompt compact-drop-prompt">
                  <i class="fas fa-road"></i>
                  <span>Drag Track Here</span>
                </div>
              {{/if}}
            </div>
          </div>
        {{/each}}
        
        {{#unless trackSlots.length}}
          <div class="no-slots-message">
            <i class="fas fa-info-circle"></i>
            <span>No track slots available at level {{system.level}}.</span>
          </div>
        {{/unless}}
      </div>
    </div>

    <!-- Talents Section -->
    <div class="build-category talents-section">
      <h4><i class="fas fa-gem"></i> Talents</h4>
      <div class="talents-grid">
        {{#each talentSlots as |slot index|}}
          <div class="talent-slot">
            <!-- Enhanced label with track information -->
            <label class="slot-label">
              Talent {{slot.talentNumber}}
              {{#if slot.hasTrack}}
                <span class="track-source">(Track {{slot.trackNumber}}: {{slot.trackName}})</span>
              {{else}}
                <span class="track-source track-missing">(Track {{slot.trackNumber}}: Not Assigned)</span>
              {{/if}}
            </label>
            
            <div class="talent-drop-zone drop-zone {{#unless slot.hasTrack}}track-missing{{/unless}}" 
                data-item-type="talent" 
                data-slot="talent-{{slot.index}}" 
                title="{{#if slot.hasTrack}}Drag a Talent item here (provided by {{slot.trackName}}){{else}}Drag a Talent item here (requires Track {{slot.trackNumber}} to be assigned){{/if}}">
              
              {{#if slot.item}}
                <div class="slotted-item" data-item-id="{{slot.item._id}}">
                  <img class="item-image" src="{{slot.item.img}}" alt="{{slot.item.name}}" />
                  <div class="item-info">
                    <div class="item-name">{{slot.item.name}}</div>
                    <div class="item-details">
                      {{#if slot.item.system.talentType}}
                        Type: {{slot.item.system.talentType}}
                      {{/if}}
                      {{#if slot.item.system.knacksProvided}}
                        â€¢ Knacks: +{{slot.item.system.knacksProvided}}
                      {{/if}}
                    </div>
                  </div>
                  <div class="item-controls">
                    <a class="item-control item-edit" title="Edit {{slot.item.name}}">
                      <i class="fas fa-edit"></i>
                    </a>
                    <a class="item-control item-remove" title="Remove {{slot.item.name}}">
                      <i class="fas fa-times"></i>
                    </a>
                  </div>
                </div>
              {{else}}
                <div class="drop-prompt">
                  <i class="fas fa-gem"></i>
                  <span>Drag Talent Here</span>
                  {{#unless slot.hasTrack}}
                    <div class="drop-requirement">Requires Track {{slot.trackNumber}}</div>
                  {{/unless}}
                </div>
              {{/if}}
            </div>
          </div>
        {{/each}}
        
        {{#unless talentSlots.length}}
          <div class="no-slots-message">
            <i class="fas fa-info-circle"></i>
            <span>No talent slots available at level {{system.level}}.</span>
          </div>
        {{/unless}}
      </div>
    </div>

  </div>

</div>
